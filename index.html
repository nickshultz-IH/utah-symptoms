<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Intermountain Health Map</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet">
  <style>
    html,body{height:100%;margin:0;font-family:'Source Sans 3',sans-serif;}
    #map{height:100vh;width:100%;}
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Load your config first -->
  <script src="config.js"></script>

  <script>
    async function fetchSheetRows() {
      const cfg = window.APP_CONFIG;
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${cfg.DATA.sheetId}/values/${encodeURIComponent(cfg.DATA.sheetRange)}?key=${cfg.DATA.sheetsApiKey}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Sheets API ${res.status}`);
      const json = await res.json();
      const rows = json.values || [];
      const headers = rows[0].map(h=>h.trim());
      return rows.slice(1).map(r => Object.fromEntries(headers.map((h,i)=>[h,r[i]||""])));
    }

    async function initMap() {
      const cfg = window.APP_CONFIG;

      const map = new google.maps.Map(document.getElementById('map'), {
        center: cfg.MAP.center,
        zoom: cfg.MAP.zoom,
        minZoom: cfg.MAP.minZoom,
        styles: [
          {"featureType":"administrative","elementType":"all","stylers":[{"saturation":"-100"}]},
          {"featureType":"administrative.province","elementType":"all","stylers":[{"visibility":"off"}]},
          {"featureType":"landscape","elementType":"all","stylers":[{"saturation":-100},{"lightness":65},{"visibility":"on"}]},
          {"featureType":"poi","elementType":"all","stylers":[{"saturation":-100},{"lightness":"50"},{"visibility":"simplified"}]},
          {"featureType":"road","elementType":"all","stylers":[{"saturation":"-100"}]},
          {"featureType":"road.highway","elementType":"all","stylers":[{"visibility":"simplified"}]},
          {"featureType":"road.arterial","elementType":"all","stylers":[{"lightness":"30"}]},
          {"featureType":"road.local","elementType":"all","stylers":[{"lightness":"40"}]},
          {"featureType":"transit","elementType":"all","stylers":[{"saturation":-100},{"visibility":"simplified"}]},
          {"featureType":"water","elementType":"geometry","stylers":[{"hue":"#ffff00"},{"lightness":-25},{"saturation":-97}]},
          {"featureType":"water","elementType":"labels","stylers":[{"lightness":-25},{"saturation":-100}]}
        ]
      });

      const info = new google.maps.InfoWindow();

      try {
        const rows = await fetchSheetRows();
        rows.forEach(row=>{
          const lat = parseFloat(row.Latitude);
          const lng = parseFloat(row.Longitude);
          if(!lat||!lng) return;

          const marker = new google.maps.Marker({
            position:{lat,lng},
            map,
            title: row.Name || "Untitled",
            icon: cfg.MAP.iconsByGroup[row.Group] || null
          });

          marker.addListener("click",()=>{
            const html = `
              <div style="width:280px">
                <h3 style="margin:0 0 4px">${row.Name||"Untitled"}</h3>
                <div>${row.Address||""}</div>
                ${row.URL?`<p><a href="${row.URL}" target="_blank">Learn more</a></p>`:""}
              </div>`;
            info.setContent(html);
            info.open({anchor:marker,map,shouldFocus:false});
          });
        });
      } catch(err) {
        console.error(err);
        alert("Error loading sheet data: " + err.message);
      }
    }

    window.initMap = initMap;
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBc6wdW7Dz9P0oq-x6SoOJmySHwEBbfo-I&callback=initMap" async defer></script>
</body>
</html>
